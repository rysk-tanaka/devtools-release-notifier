name: Check Development Tools Releases

on:
  schedule:
    # Run daily at 10:00 UTC (19:00 JST)
    - cron: '0 10 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-releases:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v3

      - name: Install Python
        run: uv python install

      - name: Install dependencies
        run: uv sync

      - name: Check for new releases
        id: check
        run: |
          uv run devtools-notifier --output releases.json --no-notify
          if [ -f releases.json ]; then
            echo "has_releases=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Found new releases:"
            cat releases.json
            # Save releases data to output for Claude translation
            echo "releases_data<<EOF" >> $GITHUB_OUTPUT
            cat releases.json >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_releases=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No new releases found"
          fi

      - name: Translate with Claude
        if: steps.check.outputs.has_releases == 'true'
        id: translate
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ä»¥ä¸‹ã¯é–‹ç™ºãƒ„ãƒ¼ãƒ«ã®ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã§ã™ã€‚å„ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦æ—¥æœ¬èªã§è¦ç´„ã—ã¦ãã ã•ã„ã€‚

            ${{ steps.check.outputs.releases_data }}

            å„ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®å½¢å¼ã§JSONé…åˆ—ã¨ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
            [
              {
                "tool_name": "Zed Editor",
                "translated_content": "## ğŸ“Œ ä¸»ãªå¤‰æ›´ç‚¹\n- å¤‰æ›´1\n- å¤‰æ›´2\n- å¤‰æ›´3"
              }
            ]

            é‡è¦:
            - è¦ç´„ã¯3-5å€‹ã®ä¸»ãªå¤‰æ›´ç‚¹ã‚’ç°¡æ½”ã«è¨˜è¼‰ã—ã¦ãã ã•ã„
            - JSONã®ã¿ã‚’å‡ºåŠ›ã—ã€è¿½åŠ ã®èª¬æ˜ã¯ä¸è¦ã§ã™
            - tool_nameã¯å…ƒã®ãƒ„ãƒ¼ãƒ«åã¨å®Œå…¨ã«ä¸€è‡´ã•ã›ã¦ãã ã•ã„
          claude_args: '--allowed-tools "read,grep,glob" --max-turns 5'

      - name: Extract Claude response
        if: steps.check.outputs.has_releases == 'true'
        id: extract
        run: |
          echo "ğŸ” Extracting translation from execution file..."
          TRANSLATED=$(uv run python .github/scripts/extract_claude_response.py ${{ steps.translate.outputs.execution_file }})
          echo "translated<<EOF" >> $GITHUB_OUTPUT
          echo "$TRANSLATED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "âœ“ Extracted translation:"
          echo "$TRANSLATED"

      - name: Send to Discord
        id: discord
        if: steps.check.outputs.has_releases == 'true'
        continue-on-error: true
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          echo "ğŸ“¤ Sending notifications to Discord..."
          EXIT_CODE=0
          uv run python .github/scripts/send_to_discord.py \
            releases.json \
            '${{ steps.extract.outputs.translated }}' || EXIT_CODE=$?

          # Output GitHub Actions annotation based on exit code
          if [ $EXIT_CODE -eq 0 ]; then
            echo "::notice::All Discord notifications sent successfully"
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "::warning::Partial failure: Some Discord notifications failed. Check logs for details."
          elif [ $EXIT_CODE -eq 1 ]; then
            echo "::error::All Discord notifications failed. Please check webhook configuration and logs."
          fi

          exit $EXIT_CODE

      - name: Commit cache updates
        if: steps.check.outputs.has_releases == 'true'
        continue-on-error: true
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add cache/*.json
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No cache changes to commit"
          else
            git commit -m "chore: update release cache [skip ci]"
            git push
            echo "âœ“ Cache updated"
          fi
